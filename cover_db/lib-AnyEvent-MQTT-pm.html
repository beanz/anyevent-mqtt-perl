<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.66
Devel::Cover is copyright 2001-2010, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: lib/AnyEvent/MQTT.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">lib/AnyEvent/MQTT.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c2">96.1%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L1">15</a></div></td><td></td><td><div>1.9866290911537e+16</div><div>107</div><div>1562</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">2</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L2">15</a></div></td><td></td><td><div>210</div><div>72</div><div>2974</div></td><td class="s">use warnings;</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package AnyEvent::MQTT;</td></tr>
<tr><td class="h">4</td><td colspan="7"></td></tr><tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># ABSTRACT: AnyEvent module for an MQTT client</td></tr>
<tr><td class="h">6</td><td colspan="7"></td></tr><tr><td class="h">7 - 45</td><td colspan="6"></td><td class="s"><pre>=head1 SYNOPSIS

  use AnyEvent::MQTT;
  my $mqtt = AnyEvent::MQTT-&gt;new;
  my $cv = $mqtt-&gt;subscribe(topic =&gt; &#39;/topic&#39;,
                            callback =&gt; sub {
                                 my ($topic, $message) = @_;
                                 print $topic, &#39; &#39;, $message, &quot;\n&quot;
                               });
  my $qos = $cv-&gt;recv; # subscribed, negotiated QoS == $qos

  # publish a simple message
  $cv = $mqtt-&gt;publish(message =&gt; &#39;simple message&#39;,
                          topic =&gt; &#39;/topic&#39;);
  $cv-&gt;recv; # sent

  # publish line-by-line from file handle
  $cv =  $mqtt-&gt;publish(handle =&gt; \*STDIN,
                        topic =&gt; &#39;/topic&#39;);
  $cv-&gt;recv; # sent

  # publish from AnyEvent::Handle
  $cv = $mqtt-&gt;publish(handle =&gt; AnyEvent::Handle-&gt;new(my %handle_args),
                       topic =&gt; &#39;/topic&#39;);
  $cv-&gt;recv; # sent

=head1 DESCRIPTION

AnyEvent module for MQTT client.

B&lt;IMPORTANT:&gt; This is an early release and the API is still subject to
change.

=head1 DISCLAIMER

This is B&lt;not&gt; official IBM code.  I work for IBM but I&#39;m writing this
in my spare time (with permission) for fun.

=cut</pre></td></tr>
<tr><td class="h">46</td><td colspan="7"></td></tr><tr><td class="h">47</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L47">15</a></div></td><td></td><td><div>220</div><div>137</div><div>2366</div></td><td class="s">use constant DEBUG =&gt; $ENV{ANYEVENT_MQTT_DEBUG};</td></tr>
<tr><td class="h">48</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L48">15</a></div></td><td></td><td><div>202</div><div>76</div><div>1212</div></td><td class="s">use AnyEvent;</td></tr>
<tr><td class="h">49</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L49">15</a></div></td><td></td><td><div>204</div><div>79</div><div>1000</div></td><td class="s">use AnyEvent::Handle;</td></tr>
<tr><td class="h">50</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L50">15</a></div></td><td></td><td><div>249</div><div>97</div><div>589</div></td><td class="s">use Net::MQTT::Constants;</td></tr>
<tr><td class="h">51</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L51">15</a></div></td><td></td><td><div>22497</div><div>1171940</div><div>1460</div></td><td class="s">use Net::MQTT::Message;</td></tr>
<tr><td class="h">52</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L52">15</a></div></td><td></td><td><div>6719</div><div>21904</div><div>1506</div></td><td class="s">use Net::MQTT::TopicStore;</td></tr>
<tr><td class="h">53</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L53">15</a></div></td><td></td><td><div>225</div><div>74</div><div>2542</div></td><td class="s">use Carp qw/croak carp/;</td></tr>
<tr><td class="h">54</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L54">15</a></div></td><td></td><td><div>200</div><div>73</div><div>2036</div></td><td class="s">use Sub::Name;</td></tr>
<tr><td class="h">55</td><td><div class="c3">15</div><div class="c3">15</div><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L55">15</a></div></td><td></td><td><div>197</div><div>162</div><div>221085</div></td><td class="s">use Scalar::Util qw/weaken/;</td></tr>
<tr><td class="h">56</td><td colspan="7"></td></tr><tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=method C&lt;new(%params)&gt;</td></tr>
<tr><td class="h">58</td><td colspan="7"></td></tr><tr><td class="h">59</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">Constructs a new C&lt;AnyEvent::MQTT&gt; object.  The supported parameters</td></tr>
<tr><td class="h">60</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">are:</td></tr>
<tr><td class="h">61</td><td colspan="7"></td></tr><tr><td class="h">62 - 113</td><td colspan="6"></td><td class="s"><pre>=over

=item C&lt;host&gt;

The server host.  Defaults to C&lt;127.0.0.1&gt;.

=item C&lt;port&gt;

The server port.  Defaults to C&lt;1883&gt;.

=item C&lt;timeout&gt;

The timeout for responses from the server.

=item C&lt;keep_alive_timer&gt;

The keep alive timer.

=item C&lt;will_topic&gt;

Set topic for will message.  Default is undef which means no will
message will be configured.

=item C&lt;will_qos&gt;

Set QoS for will message.  Default is &#39;at-most-once&#39;.

=item C&lt;will_retain&gt;

Set retain flag for will message.  Default is 0.

=item C&lt;will_message&gt;

Set message for will message.  Default is the empty message.

=item C&lt;clean_session&gt;

Set clean session flag for connect message.  Default is 1 but
it is set to 0 when reconnecting after an error.

=item C&lt;client_id&gt;

Sets the client id for the client overriding the default which
is C&lt;Net::MQTT::Message[NNNNN]&gt; where NNNNN is the process id.

=item C&lt;message_log_callback&gt;

Defines a callback to call on every message.

=back

=cut</pre></td></tr>
<tr><td class="h">114</td><td colspan="7"></td></tr><tr><td class="h">115</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new {</td></tr>
<tr><td class="h">116</td><td><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L116">15</a></div></td><td></td><td><div>18173</div></td><td class="s">&nbsp;&nbsp;my ($pkg, %p) = @_;</td></tr>
<tr><td class="h">117</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>632</div></td><td class="s">&nbsp;&nbsp;my $self =</td></tr>
<tr><td class="h">118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;bless {</td></tr>
<tr><td class="h">119</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket =&gt; undef,</td></tr>
<tr><td class="h">120</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host =&gt; &#39;127.0.0.1&#39;,</td></tr>
<tr><td class="h">121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port =&gt; &#39;1883&#39;,</td></tr>
<tr><td class="h">122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timeout =&gt; 30,</td></tr>
<tr><td class="h">123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wait =&gt; &#39;nothing&#39;,</td></tr>
<tr><td class="h">124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keep_alive_timer =&gt; 120,</td></tr>
<tr><td class="h">125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qos =&gt; MQTT_QOS_AT_MOST_ONCE,</td></tr>
<tr><td class="h">126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_id =&gt; 1,</td></tr>
<tr><td class="h">127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user_name =&gt; undef,</td></tr>
<tr><td class="h">128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;password =&gt; undef,</td></tr>
<tr><td class="h">129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will_topic =&gt; undef,</td></tr>
<tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will_qos =&gt; MQTT_QOS_AT_MOST_ONCE,</td></tr>
<tr><td class="h">131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will_retain =&gt; 0,</td></tr>
<tr><td class="h">132</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will_message =&gt; &#39;&#39;,</td></tr>
<tr><td class="h">133</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client_id =&gt; undef,</td></tr>
<tr><td class="h">134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clean_session =&gt; 1,</td></tr>
<tr><td class="h">135</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write_queue =&gt; [],</td></tr>
<tr><td class="h">136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inflight =&gt; {},</td></tr>
<tr><td class="h">137</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_sub_topics =&gt; Net::MQTT::TopicStore-&gt;new(),</td></tr>
<tr><td class="h">138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%p,</td></tr>
<tr><td class="h">139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, $pkg;</td></tr>
<tr><td class="h">140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">141</td><td colspan="7"></td></tr><tr><td class="h">142</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub DESTROY {</td></tr>
<tr><td class="h">143</td><td><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L143">15</a></div></td><td></td><td><div>163726</div></td><td class="s">&nbsp;&nbsp;$_[0]-&gt;cleanup;</td></tr>
<tr><td class="h">144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">145</td><td colspan="7"></td></tr><tr><td class="h">146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=method C&lt;cleanup()&gt;</td></tr>
<tr><td class="h">147</td><td colspan="7"></td></tr><tr><td class="h">148</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">This method attempts to destroy any resources in the event of a</td></tr>
<tr><td class="h">149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">disconnection or fatal error.</td></tr>
<tr><td class="h">150</td><td colspan="7"></td></tr><tr><td class="h">151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=cut</td></tr>
<tr><td class="h">152</td><td colspan="7"></td></tr><tr><td class="h">153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub cleanup {</td></tr>
<tr><td class="h">154</td><td><div class="c3">20</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L154">20</a></div></td><td></td><td><div>227</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">155</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>155</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;cleanup\n&quot; if DEBUG;</td></tr>
<tr><td class="h">156</td><td><div class="c3">20</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L156">100</a></div></td><td></td><td></td><td></td><td><div>399</div></td><td class="s">&nbsp;&nbsp;if ($self-&gt;{handle}) {</td></tr>
<tr><td class="h">157</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>1044</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cv = AnyEvent-&gt;condvar;</td></tr>
<tr><td class="h">158</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>889</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handle = $self-&gt;{handle};</td></tr>
<tr><td class="h">159</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>343</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;weaken $handle;</td></tr>
<tr><td class="h">160</td><td><div class="c3">18</div><div class="c3">11</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L160">11</a></div></td><td></td><td><div>1061</div><div>852</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cv-&gt;cb(sub { $handle-&gt;destroy });</td></tr>
<tr><td class="h">161</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>1153</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_send(message_type =&gt; MQTT_DISCONNECT, cv =&gt; $cv);</td></tr>
<tr><td class="h">162</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">163</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>404</div></td><td class="s">&nbsp;&nbsp;delete $self-&gt;{handle};</td></tr>
<tr><td class="h">164</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>993</div></td><td class="s">&nbsp;&nbsp;delete $self-&gt;{connected};</td></tr>
<tr><td class="h">165</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>149</div></td><td class="s">&nbsp;&nbsp;delete $self-&gt;{wait};</td></tr>
<tr><td class="h">166</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>339</div></td><td class="s">&nbsp;&nbsp;delete $self-&gt;{_keep_alive_handle};</td></tr>
<tr><td class="h">167</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>151</div></td><td class="s">&nbsp;&nbsp;delete $self-&gt;{_keep_alive_waiting};</td></tr>
<tr><td class="h">168</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>1211</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{write_queue} = [];</td></tr>
<tr><td class="h">169</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">170</td><td colspan="7"></td></tr><tr><td class="h">171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _error {</td></tr>
<tr><td class="h">172</td><td><div class="c3">5</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L172">5</a></div></td><td></td><td><div>457</div></td><td class="s">&nbsp;&nbsp;my ($self, $fatal, $message, $reconnect) = @_;</td></tr>
<tr><td class="h">173</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>68</div></td><td class="s">&nbsp;&nbsp;$self-&gt;cleanup($message);</td></tr>
<tr><td class="h">174</td><td><div class="c3">5</div></td><td><div class="c0" title="T/-"><a href="lib-AnyEvent-MQTT-pm--branch.html#L174">50</a></div></td><td></td><td></td><td></td><td><div>248</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{on_error}-&gt;($fatal, $message) if ($self-&gt;{on_error});</td></tr>
<tr><td class="h">175</td><td><div class="c3">5</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L175">100</a></div></td><td></td><td></td><td></td><td><div>626</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_reconnect() if ($reconnect);</td></tr>
<tr><td class="h">176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">177</td><td colspan="7"></td></tr><tr><td class="h">178</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=method C&lt;publish( %parameters )&gt;</td></tr>
<tr><td class="h">179</td><td colspan="7"></td></tr><tr><td class="h">180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">This method is used to publish to a given topic.  It returns an</td></tr>
<tr><td class="h">181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">L&lt;AnyEvent condvar|AnyEvent/&quot;CONDITION VARIABLES&quot;&gt; which is notified</td></tr>
<tr><td class="h">182</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">when the publish is complete (written to the kernel or ack&#39;d depending</td></tr>
<tr><td class="h">183</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">on the QoS level).  The parameter hash must included at least a</td></tr>
<tr><td class="h">184</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">B&lt;topic&gt; value and one of:</td></tr>
<tr><td class="h">185</td><td colspan="7"></td></tr><tr><td class="h">186 - 224</td><td colspan="6"></td><td class="s"><pre>=over

=item B&lt;message&gt;

  with a string value which is published to the topic,

=item B&lt;handle&gt;

 the value of which must either be an L&lt;AnyEvent::Handle&gt; or will be
 passed to an L&lt;AnyEvent::Handle&gt; constructor as the C&lt;fh&gt; argument.
 The L&lt;push_read()&gt; method is called on the L&lt;AnyEvent::Handle&gt; with a
 callback that will publish each chunk read to the topic.

=back

The parameter hash may also keys for:

=over

=item C&lt;qos&gt;

  to set the QoS level for published messages (default
  MQTT_QOS_AT_MOST_ONCE),

=item C&lt;handle_args&gt;

  a reference to a list to pass as arguments to the
  L&lt;AnyEvent::Handle&gt; constructor in the final case above (defaults to
  an empty list reference), or

=item C&lt;push_read_args&gt;

  a reference to a list to pass as the arguments to the
  L&lt;AnyEvent::Handle#push_read&gt; method (defaults to [&#39;line&#39;] to read,
  and subsequently publish, a line at a time.

=back

=cut</pre></td></tr>
<tr><td class="h">225</td><td colspan="7"></td></tr><tr><td class="h">226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub publish {</td></tr>
<tr><td class="h">227</td><td><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L227">8</a></div></td><td></td><td><div>49313</div></td><td class="s">&nbsp;&nbsp;my ($self, %p) = @_;</td></tr>
<tr><td class="h">228</td><td><div class="c3">8</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L228">100</a></div></td><td></td><td></td><td></td><td><div>171</div></td><td class="s">&nbsp;&nbsp;my $topic = exists $p{topic} ? $p{topic} :</td></tr>
<tr><td class="h">229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak ref $self, &#39;-&gt;publish requires &quot;topic&quot; parameter&#39;;</td></tr>
<tr><td class="h">230</td><td><div class="c3">7</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L230">100</a></div></td><td></td><td></td><td></td><td><div>91</div></td><td class="s">&nbsp;&nbsp;my $qos = exists $p{qos} ? $p{qos} : MQTT_QOS_AT_MOST_ONCE;</td></tr>
<tr><td class="h">231</td><td><div class="c3">7</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L231">100</a></div></td><td></td><td></td><td></td><td><div>308</div></td><td class="s">&nbsp;&nbsp;my $cv = exists $p{cv} ? delete $p{cv} : AnyEvent-&gt;condvar;</td></tr>
<tr><td class="h">232</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>253</div></td><td class="s">&nbsp;&nbsp;my $expect;</td></tr>
<tr><td class="h">233</td><td><div class="c3">7</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L233">100</a></div></td><td></td><td></td><td></td><td><div>97</div></td><td class="s">&nbsp;&nbsp;if ($qos) {</td></tr>
<tr><td class="h">234</td><td><div class="c3">3</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L234">100</a></div></td><td></td><td></td><td></td><td><div>38</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$expect = ($qos == MQTT_QOS_AT_LEAST_ONCE ? MQTT_PUBACK : MQTT_PUBREC);</td></tr>
<tr><td class="h">235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">236</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>62</div></td><td class="s">&nbsp;&nbsp;my $message = $p{message};</td></tr>
<tr><td class="h">237</td><td><div class="c3">7</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L237">100</a></div></td><td></td><td></td><td></td><td><div>86</div></td><td class="s">&nbsp;&nbsp;if (defined $message) {</td></tr>
<tr><td class="h">238</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>29</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;publish: message[$message] =&gt; $topic\n&quot; if DEBUG;</td></tr>
<tr><td class="h">239</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>100</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_send_with_ack({</td></tr>
<tr><td class="h">240</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_type =&gt; MQTT_PUBLISH,</td></tr>
<tr><td class="h">241</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%p,</td></tr>
<tr><td class="h">242</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, $cv, $expect);</td></tr>
<tr><td class="h">243</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>117</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $cv;</td></tr>
<tr><td class="h">244</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">245</td><td><div class="c3">3</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L245">100</a></div></td><td></td><td></td><td></td><td><div>122</div></td><td class="s">&nbsp;&nbsp;my $handle = exists $p{handle} ? $p{handle} :</td></tr>
<tr><td class="h">246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak ref $self, &#39;-&gt;publish requires &quot;message&quot; or &quot;handle&quot; parameter&#39;;</td></tr>
<tr><td class="h">247</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L247">100</a></div></td><td></td><td></td><td></td><td><div>73</div></td><td class="s">&nbsp;&nbsp;unless ($handle-&gt;isa(&#39;AnyEvent::Handle&#39;)) {</td></tr>
<tr><td class="h">248</td><td><div class="c3">1</div><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L248">50</a></div></td><td></td><td></td><td></td><td><div>6</div><div>15</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @args = @{$p{handle_args}||[]};</td></tr>
<tr><td class="h">249</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;publish: IO[$handle] =&gt; $topic @args\n&quot; if DEBUG;</td></tr>
<tr><td class="h">250</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>32</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handle = AnyEvent::Handle-&gt;new(fh =&gt; $handle, @args);</td></tr>
<tr><td class="h">251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">252</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>232</div></td><td class="s">&nbsp;&nbsp;my $error_sub = $handle-&gt;{on_error}; # Hack: There is no accessor api</td></tr>
<tr><td class="h">253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;$handle-&gt;on_error(subname &#39;on_error_for_read_publish_&#39;.$topic =&gt;</td></tr>
<tr><td class="h">254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub {</td></tr>
<tr><td class="h">255</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L255">2</a></div></td><td></td><td><div>1299</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($hdl, $fatal, $msg) = @_;</td></tr>
<tr><td class="h">256</td><td><div class="c3">2</div></td><td><div class="c0" title="T/-"><a href="lib-AnyEvent-MQTT-pm--branch.html#L256">50</a></div></td><td></td><td></td><td></td><td><div>67</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error_sub-&gt;(@_) if ($error_sub);</td></tr>
<tr><td class="h">257</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>578</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hdl-&gt;destroy;</td></tr>
<tr><td class="h">258</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>54</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef $hdl;</td></tr>
<tr><td class="h">259</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>49</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cv-&gt;send(1);</td></tr>
<tr><td class="h">260</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>136</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">261</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>63</div></td><td class="s">&nbsp;&nbsp;my $weak_self = $self;</td></tr>
<tr><td class="h">262</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>25</div></td><td class="s">&nbsp;&nbsp;weaken $weak_self;</td></tr>
<tr><td class="h">263</td><td><div class="c3">2</div><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L263">100</a></div></td><td></td><td></td><td></td><td><div>11</div><div>50</div></td><td class="s">&nbsp;&nbsp;my @push_read_args = @{$p{push_read_args}||[&#39;line&#39;]};</td></tr>
<tr><td class="h">264</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>14</div></td><td class="s">&nbsp;&nbsp;my $sub; $sub = subname &#39;push_read_cb_for_&#39;.$topic =&gt; sub {</td></tr>
<tr><td class="h">265</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L265">2</a></div></td><td></td><td><div>3482</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($hdl, $chunk, @args) = @_;</td></tr>
<tr><td class="h">266</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>17</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;publish: $chunk =&gt; $topic\n&quot; if DEBUG;</td></tr>
<tr><td class="h">267</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>100</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $send_cv = AnyEvent-&gt;condvar;</td></tr>
<tr><td class="h">268</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>89</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;publish: message[$chunk] =&gt; $topic\n&quot; if DEBUG;</td></tr>
<tr><td class="h">269</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>84</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;_send_with_ack({</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_type =&gt; MQTT_PUBLISH,</td></tr>
<tr><td class="h">271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qos =&gt; $qos,</td></tr>
<tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retain =&gt; $p{retain},</td></tr>
<tr><td class="h">273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topic =&gt; $topic,</td></tr>
<tr><td class="h">274</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message =&gt; $chunk,</td></tr>
<tr><td class="h">275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, $send_cv, $expect);</td></tr>
<tr><td class="h">276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$send_cv-&gt;cb(subname &#39;publish_ack_&#39;.$topic =&gt;</td></tr>
<tr><td class="h">277</td><td><div class="c3">2</div><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>123</div><div>108</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub { $handle-&gt;push_read(@push_read_args =&gt; $sub ) });</td></tr>
<tr><td class="h">278</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>299</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">279</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>82</div></td><td class="s">&nbsp;&nbsp;};</td></tr>
<tr><td class="h">280</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>64</div></td><td class="s">&nbsp;&nbsp;$handle-&gt;push_read(@push_read_args =&gt; $sub);</td></tr>
<tr><td class="h">281</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>742</div></td><td class="s">&nbsp;&nbsp;return $cv;</td></tr>
<tr><td class="h">282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">283</td><td colspan="7"></td></tr><tr><td class="h">284</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _send_with_ack {</td></tr>
<tr><td class="h">285</td><td><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L285">8</a></div></td><td></td><td><div>80</div></td><td class="s">&nbsp;&nbsp;my ($self, $args, $cv, $expect, $dup) = @_;</td></tr>
<tr><td class="h">286</td><td><div class="c3">8</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L286">100</a></div></td><td></td><td></td><td></td><td><div>92</div></td><td class="s">&nbsp;&nbsp;if ($args-&gt;{qos}) {</td></tr>
<tr><td class="h">287</td><td><div class="c3">5</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L287">100</a></div></td><td></td><td></td><td></td><td><div>62</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (exists $args-&gt;{message_id}) {</td></tr>
<tr><td class="h">288</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>33</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$args-&gt;{message_id} = $self-&gt;{message_id}++;</td></tr>
<tr><td class="h">289</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">290</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>39</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mid = $args-&gt;{message_id};</td></tr>
<tr><td class="h">291</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>237</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $send_cv = AnyEvent-&gt;condvar;</td></tr>
<tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$send_cv-&gt;cb(subname &#39;ack_cb_for_&#39;.$mid =&gt; sub {</td></tr>
<tr><td class="h">293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{inflight}-&gt;{$mid} =</td></tr>
<tr><td class="h">294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">295</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expect =&gt; $expect,</td></tr>
<tr><td class="h">296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message =&gt; $args,</td></tr>
<tr><td class="h">297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cv =&gt; $cv,</td></tr>
<tr><td class="h">298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timeout =&gt;</td></tr>
<tr><td class="h">299</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AnyEvent-&gt;timer(after =&gt; $self-&gt;{keep_alive_timer},</td></tr>
<tr><td class="h">300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb =&gt; subname &#39;ack_timeout_for_&#39;.$mid =&gt;</td></tr>
<tr><td class="h">301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub {</td></tr>
<tr><td class="h">302</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>177</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print ref $self, &quot; timeout waiting for &quot;,</td></tr>
<tr><td class="h">303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_type_string($expect), &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">304</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>22</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $self-&gt;{inflight}-&gt;{$mid};</td></tr>
<tr><td class="h">305</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>20</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_send_with_ack($args, $cv, $expect, 1);</td></tr>
<tr><td class="h">306</td><td><div class="c3">5</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L306">5</a></div></td><td></td><td><div>499</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}),</td></tr>
<tr><td class="h">307</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">308</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>554</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">309</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>250</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$args-&gt;{cv} = $send_cv;</td></tr>
<tr><td class="h">310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">311</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>25</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$args-&gt;{cv} = $cv;</td></tr>
<tr><td class="h">312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">313</td><td><div class="c3">8</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L313">100</a></div></td><td></td><td></td><td></td><td><div>91</div></td><td class="s">&nbsp;&nbsp;$args-&gt;{dup} = 1 if ($dup);</td></tr>
<tr><td class="h">314</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>141</div></td><td class="s">&nbsp;&nbsp;return $self-&gt;_send(%$args);</td></tr>
<tr><td class="h">315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">316</td><td colspan="7"></td></tr><tr><td class="h">317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=method C&lt;subscribe( %parameters )&gt;</td></tr>
<tr><td class="h">318</td><td colspan="7"></td></tr><tr><td class="h">319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">This method subscribes to the given topic.  The parameter hash</td></tr>
<tr><td class="h">320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">may contain values for the following keys:</td></tr>
<tr><td class="h">321</td><td colspan="7"></td></tr><tr><td class="h">322 - 346</td><td colspan="6"></td><td class="s"><pre>=over

=item B&lt;topic&gt;

  for the topic to subscribe to (this is required),

=item B&lt;callback&gt;

  for the callback to call with messages (this is required),

=item B&lt;qos&gt;

  QoS level to use (default is MQTT_QOS_AT_MOST_ONCE),

=item B&lt;cv&gt;

  L&lt;AnyEvent&gt; condvar to use to signal the subscription is complete.
  The received value will be the negotiated QoS level.

=back

This method returns the value of the B&lt;cv&gt; parameter if it was
supplied or an L&lt;AnyEvent&gt; condvar created for this purpose.

=cut</pre></td></tr>
<tr><td class="h">347</td><td colspan="7"></td></tr><tr><td class="h">348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subscribe {</td></tr>
<tr><td class="h">349</td><td><div class="c3">19</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L349">19</a></div></td><td></td><td><div>27734</div></td><td class="s">&nbsp;&nbsp;my ($self, %p) = @_;</td></tr>
<tr><td class="h">350</td><td><div class="c3">19</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L350">100</a></div></td><td></td><td></td><td></td><td><div>342</div></td><td class="s">&nbsp;&nbsp;my $topic = exists $p{topic} ? $p{topic} :</td></tr>
<tr><td class="h">351</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak ref $self, &#39;-&gt;subscribe requires &quot;topic&quot; parameter&#39;;</td></tr>
<tr><td class="h">352</td><td><div class="c3">18</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L352">100</a></div></td><td></td><td></td><td></td><td><div>249</div></td><td class="s">&nbsp;&nbsp;my $sub = exists $p{callback} ? $p{callback} :</td></tr>
<tr><td class="h">353</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak ref $self, &#39;-&gt;subscribe requires &quot;callback&quot; parameter&#39;;</td></tr>
<tr><td class="h">354</td><td><div class="c3">17</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L354">100</a></div></td><td></td><td></td><td></td><td><div>182</div></td><td class="s">&nbsp;&nbsp;my $qos = exists $p{qos} ? $p{qos} : MQTT_QOS_AT_MOST_ONCE;</td></tr>
<tr><td class="h">355</td><td><div class="c3">17</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L355">100</a></div></td><td></td><td></td><td></td><td><div>734</div></td><td class="s">&nbsp;&nbsp;my $cv = exists $p{cv} ? delete $p{cv} : AnyEvent-&gt;condvar;</td></tr>
<tr><td class="h">356</td><td><div class="c3">17</div></td><td></td><td></td><td></td><td></td><td><div>674</div></td><td class="s">&nbsp;&nbsp;my $mid = $self-&gt;_add_subscription($topic, $cv, $sub);</td></tr>
<tr><td class="h">357</td><td><div class="c3">17</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L357">100</a></div></td><td></td><td></td><td></td><td><div>204</div></td><td class="s">&nbsp;&nbsp;if (defined $mid) { # not already subscribed/subscribing</td></tr>
<tr><td class="h">358</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>208</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_send(message_type =&gt; MQTT_SUBSCRIBE,</td></tr>
<tr><td class="h">359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_id =&gt; $mid,</td></tr>
<tr><td class="h">360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topics =&gt; [[$topic, $qos]]);</td></tr>
<tr><td class="h">361</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;$cv</td></tr>
<tr><td class="h">363</td><td><div class="c3">17</div></td><td></td><td></td><td></td><td></td><td><div>509</div></td><td class="s">}</td></tr>
<tr><td class="h">364</td><td colspan="7"></td></tr><tr><td class="h">365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=method C&lt;unsubscribe( %parameters )&gt;</td></tr>
<tr><td class="h">366</td><td colspan="7"></td></tr><tr><td class="h">367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">This method unsubscribes to the given topic.  The parameter hash</td></tr>
<tr><td class="h">368</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">may contain values for the following keys:</td></tr>
<tr><td class="h">369</td><td colspan="7"></td></tr><tr><td class="h">370 - 390</td><td colspan="6"></td><td class="s"><pre>=over

=item B&lt;topic&gt;

  for the topic to unsubscribe from (this is required),

=item B&lt;callback&gt;

  for the callback to call with messages (this is optional and currently
  not supported - all callbacks are unsubscribed),

=item B&lt;cv&gt;

  L&lt;AnyEvent&gt; condvar to use to signal the unsubscription is complete.

=back

This method returns the value of the B&lt;cv&gt; parameter if it was
supplied or an L&lt;AnyEvent&gt; condvar created for this purpose.

=cut</pre></td></tr>
<tr><td class="h">391</td><td colspan="7"></td></tr><tr><td class="h">392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unsubscribe {</td></tr>
<tr><td class="h">393</td><td><div class="c3">7</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L393">7</a></div></td><td></td><td><div>22380</div></td><td class="s">&nbsp;&nbsp;my ($self, %p) = @_;</td></tr>
<tr><td class="h">394</td><td><div class="c3">7</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L394">100</a></div></td><td></td><td></td><td></td><td><div>248</div></td><td class="s">&nbsp;&nbsp;my $topic = exists $p{topic} ? $p{topic} :</td></tr>
<tr><td class="h">395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak ref $self, &#39;-&gt;unsubscribe requires &quot;topic&quot; parameter&#39;;</td></tr>
<tr><td class="h">396</td><td><div class="c3">6</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L396">100</a></div></td><td></td><td></td><td></td><td><div>365</div></td><td class="s">&nbsp;&nbsp;my $cv = exists $p{cv} ? delete $p{cv} : AnyEvent-&gt;condvar;</td></tr>
<tr><td class="h">397</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>319</div></td><td class="s">&nbsp;&nbsp;my $mid = $self-&gt;_remove_subscription($topic, $cv, $p{callback});</td></tr>
<tr><td class="h">398</td><td><div class="c3">6</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L398">100</a></div></td><td></td><td></td><td></td><td><div>115</div></td><td class="s">&nbsp;&nbsp;if (defined $mid) { # not already subscribed/subscribing</td></tr>
<tr><td class="h">399</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>48</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_send(message_type =&gt; MQTT_UNSUBSCRIBE,</td></tr>
<tr><td class="h">400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_id =&gt; $mid,</td></tr>
<tr><td class="h">401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topics =&gt; [$topic]);</td></tr>
<tr><td class="h">402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">403</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;$cv</td></tr>
<tr><td class="h">404</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>258</div></td><td class="s">}</td></tr>
<tr><td class="h">405</td><td colspan="7"></td></tr><tr><td class="h">406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _add_subscription {</td></tr>
<tr><td class="h">407</td><td><div class="c3">17</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L407">17</a></div></td><td></td><td><div>180</div></td><td class="s">&nbsp;&nbsp;my ($self, $topic, $cv, $sub) = @_;</td></tr>
<tr><td class="h">408</td><td><div class="c3">17</div></td><td></td><td></td><td></td><td></td><td><div>179</div></td><td class="s">&nbsp;&nbsp;my $rec = $self-&gt;{_sub}-&gt;{$topic};</td></tr>
<tr><td class="h">409</td><td><div class="c3">17</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L409">100</a></div></td><td></td><td></td><td></td><td><div>224</div></td><td class="s">&nbsp;&nbsp;if ($rec) {</td></tr>
<tr><td class="h">410</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>29</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;Add $sub to existing $topic subscription\n&quot; if DEBUG;</td></tr>
<tr><td class="h">411</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>59</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rec-&gt;{cb}-&gt;{$sub} = $sub;</td></tr>
<tr><td class="h">412</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>128</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cv-&gt;send($rec-&gt;{qos});</td></tr>
<tr><td class="h">413</td><td><div class="c3">2</div><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>200</div><div>69</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $msg (values %{$rec-&gt;{retained}}) {</td></tr>
<tr><td class="h">414</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sub-&gt;($msg-&gt;topic, $msg-&gt;message, $msg);</td></tr>
<tr><td class="h">415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">416</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>48</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">417</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">418</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>132</div></td><td class="s">&nbsp;&nbsp;$rec = $self-&gt;{_sub_pending}-&gt;{$topic};</td></tr>
<tr><td class="h">419</td><td><div class="c3">15</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L419">100</a></div></td><td></td><td></td><td></td><td><div>168</div></td><td class="s">&nbsp;&nbsp;if ($rec) {</td></tr>
<tr><td class="h">420</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>22</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;Add $sub to existing pending $topic subscription\n&quot; if DEBUG;</td></tr>
<tr><td class="h">421</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>32</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rec-&gt;{cb}-&gt;{$sub} = $sub;</td></tr>
<tr><td class="h">422</td><td><div class="c3">3</div><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>20</div><div>57</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @{$rec-&gt;{cv}}, $cv;</td></tr>
<tr><td class="h">423</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>33</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">424</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">425</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>118</div></td><td class="s">&nbsp;&nbsp;my $mid = $self-&gt;{message_id}++;</td></tr>
<tr><td class="h">426</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>73</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;Add $sub as pending $topic subscription (mid=$mid)\n&quot; if DEBUG;</td></tr>
<tr><td class="h">427</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>169</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_sub_pending_by_message_id}-&gt;{$mid} = $topic;</td></tr>
<tr><td class="h">428</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>319</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_sub_pending}-&gt;{$topic} =</td></tr>
<tr><td class="h">429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{ cb =&gt; { $sub =&gt; $sub }, cv =&gt; [ $cv ], retained =&gt; {} };</td></tr>
<tr><td class="h">430</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>155</div></td><td class="s">&nbsp;&nbsp;$mid;</td></tr>
<tr><td class="h">431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">432</td><td colspan="7"></td></tr><tr><td class="h">433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _remove_subscription {</td></tr>
<tr><td class="h">434</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L434">6</a></div></td><td></td><td><div>104</div></td><td class="s">&nbsp;&nbsp;my ($self, $topic, $cv, $sub) = @_;</td></tr>
<tr><td class="h">435</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>87</div></td><td class="s">&nbsp;&nbsp;my $rec = $self-&gt;{_unsub_pending}-&gt;{$topic};</td></tr>
<tr><td class="h">436</td><td><div class="c3">6</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L436">100</a></div></td><td></td><td></td><td></td><td><div>101</div></td><td class="s">&nbsp;&nbsp;if ($rec) {</td></tr>
<tr><td class="h">437</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>16</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;Remove of $topic with pending unsubscribe\n&quot; if DEBUG;</td></tr>
<tr><td class="h">438</td><td><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>17</div><div>26</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @{$rec-&gt;{cv}}, $cv;</td></tr>
<tr><td class="h">439</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>22</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">441</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>64</div></td><td class="s">&nbsp;&nbsp;$rec = $self-&gt;{_sub}-&gt;{$topic};</td></tr>
<tr><td class="h">442</td><td><div class="c3">5</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L442">100</a></div></td><td></td><td></td><td></td><td><div>77</div></td><td class="s">&nbsp;&nbsp;unless ($rec) {</td></tr>
<tr><td class="h">443</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>12</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;Remove of $topic with no subscription\n&quot; if DEBUG;</td></tr>
<tr><td class="h">444</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>42</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cv-&gt;send(0);</td></tr>
<tr><td class="h">445</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>64</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">447</td><td colspan="7"></td></tr><tr><td class="h">448</td><td><div class="c3">4</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L448">100</a></div></td><td></td><td></td><td></td><td><div>61</div></td><td class="s">&nbsp;&nbsp;if (defined $sub) {</td></tr>
<tr><td class="h">449</td><td><div class="c3">3</div></td><td><div class="c0" title="-/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L449">50</a></div></td><td></td><td></td><td></td><td><div>51</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (exists $rec-&gt;{cb}-&gt;{$sub}) {</td></tr>
<tr><td class="h">450</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;Remove of $topic for $sub with no subscription\n&quot;</td></tr>
<tr><td class="h">451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if DEBUG;</td></tr>
<tr><td class="h">452</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cv-&gt;send(0);</td></tr>
<tr><td class="h">453</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">454</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">455</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>38</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $rec-&gt;{cb}-&gt;{$sub};</td></tr>
<tr><td class="h">456</td><td><div class="c3">3</div><div class="c3">3</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L456">100</a></div></td><td></td><td></td><td></td><td><div>19</div><div>68</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (keys %{$rec-&gt;{cb}}) {</td></tr>
<tr><td class="h">457</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>13</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;Remove of $topic for $sub\n&quot; if DEBUG;</td></tr>
<tr><td class="h">458</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>63</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cv-&gt;send(1);</td></tr>
<tr><td class="h">459</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>112</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">462</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>26</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;Remove of $topic\n&quot; if DEBUG;</td></tr>
<tr><td class="h">463</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>33</div></td><td class="s">&nbsp;&nbsp;my $mid = $self-&gt;{message_id}++;</td></tr>
<tr><td class="h">464</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>34</div></td><td class="s">&nbsp;&nbsp;delete $self-&gt;{_sub}-&gt;{$topic};</td></tr>
<tr><td class="h">465</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>143</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_sub_topics}-&gt;delete($topic);</td></tr>
<tr><td class="h">466</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>157</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_unsub_pending_by_message_id}-&gt;{$mid} = $topic;</td></tr>
<tr><td class="h">467</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>58</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_unsub_pending}-&gt;{$topic} = { cv =&gt; [ $cv ] };</td></tr>
<tr><td class="h">468</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>98</div></td><td class="s">&nbsp;&nbsp;return $mid;</td></tr>
<tr><td class="h">469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">470</td><td colspan="7"></td></tr><tr><td class="h">471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _confirm_subscription {</td></tr>
<tr><td class="h">472</td><td><div class="c3">13</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L472">13</a></div></td><td></td><td><div>537</div></td><td class="s">&nbsp;&nbsp;my ($self, $mid, $qos) = @_;</td></tr>
<tr><td class="h">473</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td></td><td><div>186</div></td><td class="s">&nbsp;&nbsp;my $topic = delete $self-&gt;{_sub_pending_by_message_id}-&gt;{$mid};</td></tr>
<tr><td class="h">474</td><td><div class="c3">13</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L474">100</a></div></td><td></td><td></td><td></td><td><div>129</div></td><td class="s">&nbsp;&nbsp;unless (defined $topic) {</td></tr>
<tr><td class="h">475</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>34</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;carp &#39;SubAck with no pending subscription for message id: &#39;, $mid, &quot;\n&quot;;</td></tr>
<tr><td class="h">476</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>652</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">478</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>163</div></td><td class="s">&nbsp;&nbsp;my $rec = $self-&gt;{_sub}-&gt;{$topic} = delete $self-&gt;{_sub_pending}-&gt;{$topic};</td></tr>
<tr><td class="h">479</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>324</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_sub_topics}-&gt;add($topic);</td></tr>
<tr><td class="h">480</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>1199</div></td><td class="s">&nbsp;&nbsp;$rec-&gt;{qos} = $qos;</td></tr>
<tr><td class="h">481</td><td colspan="7"></td></tr><tr><td class="h">482</td><td><div class="c3">12</div><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>70</div><div>112</div></td><td class="s">&nbsp;&nbsp;foreach my $cv (@{$rec-&gt;{cv}}) {</td></tr>
<tr><td class="h">483</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>481</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cv-&gt;send($qos);</td></tr>
<tr><td class="h">484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">485</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>611</div></td><td class="s">&nbsp;&nbsp;delete $rec-&gt;{cv};</td></tr>
<tr><td class="h">486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">487</td><td colspan="7"></td></tr><tr><td class="h">488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _confirm_unsubscribe {</td></tr>
<tr><td class="h">489</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L489">3</a></div></td><td></td><td><div>98</div></td><td class="s">&nbsp;&nbsp;my ($self, $mid) = @_;</td></tr>
<tr><td class="h">490</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>43</div></td><td class="s">&nbsp;&nbsp;my $topic = delete $self-&gt;{_unsub_pending_by_message_id}-&gt;{$mid};</td></tr>
<tr><td class="h">491</td><td><div class="c3">3</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L491">100</a></div></td><td></td><td></td><td></td><td><div>40</div></td><td class="s">&nbsp;&nbsp;unless (defined $topic) {</td></tr>
<tr><td class="h">492</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>33</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;carp &#39;UnSubAck with no pending unsubscribe for message id: &#39;, $mid, &quot;\n&quot;;</td></tr>
<tr><td class="h">493</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>656</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">494</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">495</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>26</div></td><td class="s">&nbsp;&nbsp;my $rec = delete $self-&gt;{_unsub_pending}-&gt;{$topic};</td></tr>
<tr><td class="h">496</td><td><div class="c3">2</div><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>19</div><div>28</div></td><td class="s">&nbsp;&nbsp;foreach my $cv (@{$rec-&gt;{cv}}) {</td></tr>
<tr><td class="h">497</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>117</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cv-&gt;send(1);</td></tr>
<tr><td class="h">498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">500</td><td colspan="7"></td></tr><tr><td class="h">501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _send {</td></tr>
<tr><td class="h">502</td><td><div class="c3">56</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L502">56</a></div></td><td></td><td><div>233341</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">503</td><td><div class="c3">56</div></td><td></td><td></td><td></td><td></td><td><div>922</div></td><td class="s">&nbsp;&nbsp;my %p = @_;</td></tr>
<tr><td class="h">504</td><td><div class="c3">56</div></td><td></td><td></td><td></td><td></td><td><div>1140</div></td><td class="s">&nbsp;&nbsp;my $cv = delete $p{cv};</td></tr>
<tr><td class="h">505</td><td><div class="c3">56</div></td><td></td><td></td><td></td><td></td><td><div>2797</div></td><td class="s">&nbsp;&nbsp;my $msg = Net::MQTT::Message-&gt;new(%p);</td></tr>
<tr><td class="h">506</td><td><div class="c3">56</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L506">100</a></div></td><td></td><td></td><td></td><td><div>6438</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{connected} ?</td></tr>
<tr><td class="h">507</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_queue_write($msg, $cv) : $self-&gt;connect($msg, $cv);</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">509</td><td colspan="7"></td></tr><tr><td class="h">510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _queue_write {</td></tr>
<tr><td class="h">511</td><td><div class="c3">56</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L511">56</a></div></td><td></td><td><div>535</div></td><td class="s">&nbsp;&nbsp;my ($self, $msg, $cv) = @_;</td></tr>
<tr><td class="h">512</td><td><div class="c3">56</div></td><td></td><td></td><td></td><td></td><td><div>459</div></td><td class="s">&nbsp;&nbsp;my $queue = $self-&gt;{write_queue};</td></tr>
<tr><td class="h">513</td><td><div class="c3">56</div></td><td></td><td></td><td></td><td></td><td><div>315</div></td><td class="s">&nbsp;&nbsp;print STDERR &#39;Queuing: &#39;, ($cv||&#39;no cv&#39;), &#39; &#39;, $msg-&gt;string, &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">514</td><td><div class="c3">56</div><div class="c3">56</div></td><td></td><td></td><td></td><td></td><td><div>370</div><div>1356</div></td><td class="s">&nbsp;&nbsp;push @{$queue}, [$msg, $cv];</td></tr>
<tr><td class="h">515</td><td><div class="c3">56</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L515">100</a></div></td><td></td><td></td><td></td><td><div>971</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_write_now unless (defined $self-&gt;{_waiting});</td></tr>
<tr><td class="h">516</td><td><div class="c3">56</div></td><td></td><td></td><td></td><td></td><td><div>1247</div></td><td class="s">&nbsp;&nbsp;$cv;</td></tr>
<tr><td class="h">517</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">518</td><td colspan="7"></td></tr><tr><td class="h">519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _write_now {</td></tr>
<tr><td class="h">520</td><td><div class="c3">114</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L520">114</a></div></td><td></td><td><div>861</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">521</td><td><div class="c3">114</div></td><td></td><td></td><td></td><td></td><td><div>812</div></td><td class="s">&nbsp;&nbsp;my ($msg, $cv);</td></tr>
<tr><td class="h">522</td><td><div class="c3">114</div></td><td></td><td></td><td></td><td></td><td><div>907</div></td><td class="s">&nbsp;&nbsp;undef $self-&gt;{_waiting};</td></tr>
<tr><td class="h">523</td><td><div class="c3">114</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L523">100</a></div></td><td></td><td></td><td></td><td><div>1212</div></td><td class="s">&nbsp;&nbsp;if (@_) {</td></tr>
<tr><td class="h">524</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>137</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($msg, $cv) = @_;</td></tr>
<tr><td class="h">525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">526</td><td><div class="c3">98</div><div class="c3">98</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L526">100</a></div></td><td></td><td></td><td></td><td><div>559</div><div>1491</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $args = shift @{$self-&gt;{write_queue}} or return;</td></tr>
<tr><td class="h">527</td><td><div class="c3">50</div></td><td></td><td></td><td></td><td></td><td><div>605</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($msg, $cv) = @$args;</td></tr>
<tr><td class="h">528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">529</td><td><div class="c3">66</div></td><td></td><td></td><td></td><td></td><td><div>693</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_reset_keep_alive_timer();</td></tr>
<tr><td class="h">530</td><td><div class="c3">66</div></td><td></td><td></td><td></td><td></td><td><div>6875</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;Sending: &quot;, $msg-&gt;string, &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">531</td><td><div class="c3">66</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L531">100</a></div></td><td></td><td></td><td></td><td><div>791</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{message_log_callback}-&gt;(&#39;&gt;&#39;, $msg) if ($self-&gt;{message_log_callback});</td></tr>
<tr><td class="h">532</td><td><div class="c3">66</div></td><td></td><td></td><td></td><td></td><td><div>2729</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_waiting} = [$msg, $cv];</td></tr>
<tr><td class="h">533</td><td><div class="c3">66</div></td><td></td><td></td><td></td><td></td><td><div>346</div></td><td class="s">&nbsp;&nbsp;print &#39;  &#39;, (unpack &#39;H*&#39;, $msg-&gt;bytes), &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">534</td><td><div class="c3">66</div></td><td></td><td></td><td></td><td></td><td><div>2591</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{handle}-&gt;push_write($msg-&gt;bytes);</td></tr>
<tr><td class="h">535</td><td><div class="c3">66</div></td><td></td><td></td><td></td><td></td><td><div>22831</div></td><td class="s">&nbsp;&nbsp;$cv;</td></tr>
<tr><td class="h">536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">537</td><td colspan="7"></td></tr><tr><td class="h">538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _reset_keep_alive_timer {</td></tr>
<tr><td class="h">539</td><td><div class="c3">71</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L539">71</a></div></td><td></td><td><div>2591</div></td><td class="s">&nbsp;&nbsp;my ($self, $wait) = @_;</td></tr>
<tr><td class="h">540</td><td><div class="c3">71</div></td><td></td><td></td><td></td><td></td><td><div>926</div></td><td class="s">&nbsp;&nbsp;undef $self-&gt;{_keep_alive_handle};</td></tr>
<tr><td class="h">541</td><td><div class="c3">71</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L541">100</a></div></td><td></td><td></td><td></td><td><div>1714</div></td><td class="s">&nbsp;&nbsp;my $method = $wait ? &#39;_keep_alive_timeout&#39; : &#39;_send_keep_alive&#39;;</td></tr>
<tr><td class="h">542</td><td><div class="c3">71</div></td><td></td><td></td><td></td><td></td><td><div>517</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_keep_alive_waiting} = $wait;</td></tr>
<tr><td class="h">543</td><td><div class="c3">71</div></td><td></td><td></td><td></td><td></td><td><div>398</div></td><td class="s">&nbsp;&nbsp;my $weak_self = $self;</td></tr>
<tr><td class="h">544</td><td><div class="c3">71</div></td><td></td><td></td><td></td><td></td><td><div>908</div></td><td class="s">&nbsp;&nbsp;weaken $weak_self;</td></tr>
<tr><td class="h">545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;$self-&gt;{_keep_alive_handle} =</td></tr>
<tr><td class="h">546</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;AnyEvent-&gt;timer(after =&gt; $self-&gt;{keep_alive_timer},</td></tr>
<tr><td class="h">547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb =&gt; subname((substr $method, 1).&#39;_cb&#39; =&gt;</td></tr>
<tr><td class="h">548</td><td><div class="c3">71</div><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L548">4</a></div></td><td></td><td><div>5140</div><div>690292</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub { $weak_self-&gt;$method(@_) }));</td></tr>
<tr><td class="h">549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">550</td><td colspan="7"></td></tr><tr><td class="h">551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _send_keep_alive {</td></tr>
<tr><td class="h">552</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L552">3</a></div></td><td></td><td><div>44</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">553</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>29</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;Sending: keep alive\n&quot; if DEBUG;</td></tr>
<tr><td class="h">554</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>127</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_send(message_type =&gt; MQTT_PINGREQ);</td></tr>
<tr><td class="h">555</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>57</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_reset_keep_alive_timer(1);</td></tr>
<tr><td class="h">556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">557</td><td colspan="7"></td></tr><tr><td class="h">558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _keep_alive_timeout {</td></tr>
<tr><td class="h">559</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L559">1</a></div></td><td></td><td><div>15</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">560</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>10</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;keep alive timeout\n&quot; if DEBUG;</td></tr>
<tr><td class="h">561</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>16</div></td><td class="s">&nbsp;&nbsp;undef $self-&gt;{_keep_alive_waiting};</td></tr>
<tr><td class="h">562</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>51</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{handle}-&gt;destroy;</td></tr>
<tr><td class="h">563</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>726</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_error(0, &#39;keep alive timeout&#39;, 1);</td></tr>
<tr><td class="h">564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">565</td><td colspan="7"></td></tr><tr><td class="h">566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _keep_alive_received {</td></tr>
<tr><td class="h">567</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L567">3</a></div></td><td></td><td><div>27</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">568</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>19</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;keep alive received\n&quot; if DEBUG;</td></tr>
<tr><td class="h">569</td><td><div class="c3">3</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L569">100</a></div></td><td></td><td></td><td></td><td><div>59</div></td><td class="s">&nbsp;&nbsp;return unless (defined $self-&gt;{_keep_alive_waiting});</td></tr>
<tr><td class="h">570</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>18</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_reset_keep_alive_timer();</td></tr>
<tr><td class="h">571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">572</td><td colspan="7"></td></tr><tr><td class="h">573</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=method C&lt;connect( [ $msg ] )&gt;</td></tr>
<tr><td class="h">574</td><td colspan="7"></td></tr><tr><td class="h">575</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">This method starts the connection to the server.  It will be called</td></tr>
<tr><td class="h">576</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">lazily when required publish or subscribe so generally is should not</td></tr>
<tr><td class="h">577</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">be necessary to call it directly.</td></tr>
<tr><td class="h">578</td><td colspan="7"></td></tr><tr><td class="h">579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=cut</td></tr>
<tr><td class="h">580</td><td colspan="7"></td></tr><tr><td class="h">581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub connect {</td></tr>
<tr><td class="h">582</td><td><div class="c3">30</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L582">30</a></div></td><td></td><td><div>8746</div></td><td class="s">&nbsp;&nbsp;my ($self, $msg, $cv) = @_;</td></tr>
<tr><td class="h">583</td><td><div class="c3">30</div></td><td></td><td></td><td></td><td></td><td><div>202</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;connect\n&quot; if DEBUG;</td></tr>
<tr><td class="h">584</td><td><div class="c3">30</div></td><td></td><td></td><td></td><td></td><td><div>279</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{_waiting} = &#39;connect&#39;;</td></tr>
<tr><td class="h">585</td><td><div class="c3">30</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L585">100</a></div></td><td></td><td></td><td></td><td><div>468</div></td><td class="s">&nbsp;&nbsp;if ($msg) {</td></tr>
<tr><td class="h">586</td><td><div class="c3">21</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L586">100</a></div></td><td></td><td></td><td></td><td><div>727</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cv = AnyEvent-&gt;condvar unless ($cv);</td></tr>
<tr><td class="h">587</td><td><div class="c3">21</div></td><td></td><td></td><td></td><td></td><td><div>627</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_queue_write($msg, $cv);</td></tr>
<tr><td class="h">588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">589</td><td><div class="c3">9</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L589">100</a></div></td><td></td><td></td><td></td><td><div>539</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{connect_cv} = AnyEvent-&gt;condvar unless (exists $self-&gt;{connect_cv});</td></tr>
<tr><td class="h">590</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>364</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cv = $self-&gt;{connect_cv};</td></tr>
<tr><td class="h">591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">592</td><td><div class="c3">30</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L592">100</a></div></td><td></td><td></td><td></td><td><div>428</div></td><td class="s">&nbsp;&nbsp;return $cv if ($self-&gt;{handle});</td></tr>
<tr><td class="h">593</td><td colspan="7"></td></tr><tr><td class="h">594</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>114</div></td><td class="s">&nbsp;&nbsp;my $weak_self = $self;</td></tr>
<tr><td class="h">595</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>301</div></td><td class="s">&nbsp;&nbsp;weaken $weak_self;</td></tr>
<tr><td class="h">596</td><td colspan="7"></td></tr><tr><td class="h">597</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>117</div></td><td class="s">&nbsp;&nbsp;my $hd;</td></tr>
<tr><td class="h">598</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;$hd = $self-&gt;{handle} =</td></tr>
<tr><td class="h">599</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;AnyEvent::Handle-&gt;new(connect =&gt; [$self-&gt;{host}, $self-&gt;{port}],</td></tr>
<tr><td class="h">600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_error =&gt; subname(&#39;on_error_cb&#39; =&gt; sub {</td></tr>
<tr><td class="h">601</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L601">1</a></div></td><td></td><td><div>71</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($handle, $fatal, $message) = @_;</td></tr>
<tr><td class="h">602</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;handle error $_[1]\n&quot; if DEBUG;</td></tr>
<tr><td class="h">603</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>24</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handle-&gt;destroy;</td></tr>
<tr><td class="h">604</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>306</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;_error($fatal, &#39;Error: &#39;.$message, 0);</td></tr>
<tr><td class="h">605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}),</td></tr>
<tr><td class="h">606</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_eof =&gt; subname(&#39;on_eof_cb&#39; =&gt; sub {</td></tr>
<tr><td class="h">607</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L607">1</a></div></td><td></td><td><div>2165</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($handle) = @_;</td></tr>
<tr><td class="h">608</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>9</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;handle eof\n&quot; if DEBUG;</td></tr>
<tr><td class="h">609</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>37</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handle-&gt;destroy;</td></tr>
<tr><td class="h">610</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>245</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;_error(1, &#39;EOF&#39;, 1);</td></tr>
<tr><td class="h">611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}),</td></tr>
<tr><td class="h">612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_timeout =&gt; subname(&#39;on_timeout_cb&#39; =&gt; sub {</td></tr>
<tr><td class="h">613</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L613">1</a></div></td><td></td><td><div>399750</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;_error(0, $weak_self-&gt;{wait}.&#39; timeout&#39;, 1);</td></tr>
<tr><td class="h">614</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>47</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;{wait} = &#39;nothing&#39;;</td></tr>
<tr><td class="h">615</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}),</td></tr>
<tr><td class="h">616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_connect =&gt; subname(&#39;on_connect_cb&#39; =&gt; sub {</td></tr>
<tr><td class="h">617</td><td><div class="c3">16</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L617">16</a></div></td><td></td><td><div>15233</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($handle, $host, $port, $retry) = @_;</td></tr>
<tr><td class="h">618</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>122</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;TCP handshake complete\n&quot; if DEBUG;</td></tr>
<tr><td class="h">619</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>746</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg =</td></tr>
<tr><td class="h">620</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Net::MQTT::Message-&gt;new(</td></tr>
<tr><td class="h">621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_type =&gt; MQTT_CONNECT,</td></tr>
<tr><td class="h">622</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keep_alive_timer =&gt; $weak_self-&gt;{keep_alive_timer},</td></tr>
<tr><td class="h">623</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client_id =&gt; $weak_self-&gt;{client_id},</td></tr>
<tr><td class="h">624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clean_session =&gt; $weak_self-&gt;{clean_session},</td></tr>
<tr><td class="h">625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will_topic =&gt; $weak_self-&gt;{will_topic},</td></tr>
<tr><td class="h">626</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will_qos =&gt; $weak_self-&gt;{will_qos},</td></tr>
<tr><td class="h">627</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will_retain =&gt; $weak_self-&gt;{will_retain},</td></tr>
<tr><td class="h">628</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will_message =&gt; $weak_self-&gt;{will_message},</td></tr>
<tr><td class="h">629</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">630</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>1897</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;_write_now($msg);</td></tr>
<tr><td class="h">631</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>497</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handle-&gt;timeout($weak_self-&gt;{timeout});</td></tr>
<tr><td class="h">632</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>3193</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;{wait} = &#39;connack&#39;;</td></tr>
<tr><td class="h">633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handle-&gt;on_read(subname &#39;on_read_cb&#39; =&gt; sub {</td></tr>
<tr><td class="h">634</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>70625</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($hdl) = @_;</td></tr>
<tr><td class="h">635</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hdl-&gt;push_read(ref $weak_self =&gt;</td></tr>
<tr><td class="h">636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subname &#39;reader_cb&#39; =&gt; sub {</td></tr>
<tr><td class="h">637</td><td><div class="c3">58</div></td><td></td><td></td><td></td><td></td><td><div>597</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;_handle_message(@_);</td></tr>
<tr><td class="h">638</td><td><div class="c3">58</div></td><td></td><td></td><td></td><td></td><td><div>716</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1;</td></tr>
<tr><td class="h">639</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>755</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">640</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>939</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">641</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>2804</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}));</td></tr>
<tr><td class="h">642</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>45986</div></td><td class="s">&nbsp;&nbsp;return $cv</td></tr>
<tr><td class="h">643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">644</td><td colspan="7"></td></tr><tr><td class="h">645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _reconnect {</td></tr>
<tr><td class="h">646</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L646">3</a></div></td><td></td><td><div>53</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">647</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>24</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;reconnecting:\n&quot; if DEBUG;</td></tr>
<tr><td class="h">648</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>33</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{clean_session} = 0;</td></tr>
<tr><td class="h">649</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>43</div></td><td class="s">&nbsp;&nbsp;$self-&gt;connect(@_);</td></tr>
<tr><td class="h">650</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">651</td><td colspan="7"></td></tr><tr><td class="h">652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _handle_message {</td></tr>
<tr><td class="h">653</td><td><div class="c3">58</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L653">58</a></div></td><td></td><td><div>418</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">654</td><td><div class="c3">58</div></td><td></td><td></td><td></td><td></td><td><div>378</div></td><td class="s">&nbsp;&nbsp;my ($handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">655</td><td><div class="c3">58</div></td><td><div class="c0" title="-/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L655">50</a></div></td><td></td><td></td><td></td><td><div>442</div></td><td class="s">&nbsp;&nbsp;return $self-&gt;_error(0, $error, 1) if ($error);</td></tr>
<tr><td class="h">656</td><td><div class="c3">58</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L656">100</a></div></td><td></td><td></td><td></td><td><div>525</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{message_log_callback}-&gt;(&#39;&lt;&#39;, $msg) if ($self-&gt;{message_log_callback});</td></tr>
<tr><td class="h">657</td><td><div class="c3">58</div></td><td><div class="c0" title="-/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L657">50</a></div></td><td></td><td></td><td></td><td><div>1004</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_call_callback(&#39;before_msg_callback&#39; =&gt; $msg) or return;</td></tr>
<tr><td class="h">658</td><td><div class="c3">58</div></td><td></td><td></td><td></td><td></td><td><div>549</div></td><td class="s">&nbsp;&nbsp;my $msg_type = lc ref $msg;</td></tr>
<tr><td class="h">659</td><td><div class="c3">58</div></td><td></td><td></td><td></td><td></td><td><div>1332</div></td><td class="s">&nbsp;&nbsp;$msg_type =~ s/^.*:://;</td></tr>
<tr><td class="h">660</td><td><div class="c3">58</div></td><td><div class="c0" title="-/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L660">50</a></div></td><td></td><td></td><td></td><td><div>625</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_call_callback(&#39;before_&#39;.$msg_type.&#39;_callback&#39; =&gt; $msg) or return;</td></tr>
<tr><td class="h">661</td><td><div class="c3">58</div></td><td></td><td></td><td></td><td></td><td><div>472</div></td><td class="s">&nbsp;&nbsp;my $method = &#39;_process_&#39;.$msg_type;</td></tr>
<tr><td class="h">662</td><td><div class="c3">58</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L662">100</a></div></td><td></td><td></td><td></td><td><div>1001</div></td><td class="s">&nbsp;&nbsp;unless ($self-&gt;can($method)) {</td></tr>
<tr><td class="h">663</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>62</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;carp &#39;Unsupported message &#39;, $msg-&gt;string(), &quot;\n&quot;;</td></tr>
<tr><td class="h">664</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>1116</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">665</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">666</td><td><div class="c3">57</div></td><td></td><td></td><td></td><td></td><td><div>569</div></td><td class="s">&nbsp;&nbsp;my $res = $self-&gt;$method(@_);</td></tr>
<tr><td class="h">667</td><td><div class="c3">57</div></td><td></td><td></td><td></td><td></td><td><div>821</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_call_callback(&#39;after_&#39;.$msg_type.&#39;_callback&#39; =&gt; $msg, $res);</td></tr>
<tr><td class="h">668</td><td><div class="c3">57</div></td><td></td><td></td><td></td><td></td><td><div>394</div></td><td class="s">&nbsp;&nbsp;$res;</td></tr>
<tr><td class="h">669</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">670</td><td colspan="7"></td></tr><tr><td class="h">671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _call_callback {</td></tr>
<tr><td class="h">672</td><td><div class="c3">173</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L672">173</a></div></td><td></td><td><div>964</div></td><td class="s">&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">673</td><td><div class="c3">173</div></td><td></td><td></td><td></td><td></td><td><div>976</div></td><td class="s">&nbsp;&nbsp;my $cb_name = shift;</td></tr>
<tr><td class="h">674</td><td><div class="c3">173</div></td><td><div class="c0" title="T/-"><a href="lib-AnyEvent-MQTT-pm--branch.html#L674">50</a></div></td><td></td><td></td><td></td><td><div>2062</div></td><td class="s">&nbsp;&nbsp;return 1 unless (exists $self-&gt;{$cb_name});</td></tr>
<tr><td class="h">675</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{$cb_name}-&gt;(@_);</td></tr>
<tr><td class="h">676</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">677</td><td colspan="7"></td></tr><tr><td class="h">678</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_connack {</td></tr>
<tr><td class="h">679</td><td><div class="c3">13</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L679">13</a></div></td><td></td><td><div>98</div></td><td class="s">&nbsp;&nbsp;my ($self, $handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">680</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td></td><td><div>360</div></td><td class="s">&nbsp;&nbsp;$handle-&gt;timeout(undef);</td></tr>
<tr><td class="h">681</td><td><div class="c3">13</div></td><td><div class="c0" title="-/-"><a href="lib-AnyEvent-MQTT-pm--branch.html#L681">0</a></div></td><td></td><td></td><td></td><td><div>966</div></td><td class="s">&nbsp;&nbsp;unless ($msg-&gt;return_code == MQTT_CONNECT_ACCEPTED) {</td></tr>
<tr><td class="h">682</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>55</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;_error(1, &#39;Connection refused: &#39;.$msg-&gt;string, 0);</td></tr>
<tr><td class="h">683</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">684</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>324</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;Connection ready:\n&quot;, $msg-&gt;string(&#39;  &#39;), &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">685</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>120</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_write_now();</td></tr>
<tr><td class="h">686</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>117</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{connected} = 1;</td></tr>
<tr><td class="h">687</td><td><div class="c3">12</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L687">100</a></div></td><td></td><td></td><td></td><td><div>232</div></td><td class="s">&nbsp;&nbsp;$self-&gt;{connect_cv}-&gt;send(1) if ($self-&gt;{connect_cv});</td></tr>
<tr><td class="h">688</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>219</div></td><td class="s">&nbsp;&nbsp;delete $self-&gt;{connect_cv};</td></tr>
<tr><td class="h">689</td><td colspan="7"></td></tr><tr><td class="h">690</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>74</div></td><td class="s">&nbsp;&nbsp;my $weak_self = $self;</td></tr>
<tr><td class="h">691</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>121</div></td><td class="s">&nbsp;&nbsp;weaken $weak_self;</td></tr>
<tr><td class="h">692</td><td colspan="7"></td></tr><tr><td class="h">693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;$handle-&gt;on_drain(subname &#39;on_drain_cb&#39; =&gt; sub {</td></tr>
<tr><td class="h">694</td><td><div class="c3">51</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L694">51</a></div></td><td></td><td><div>24320</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;drained\n&quot; if DEBUG;</td></tr>
<tr><td class="h">695</td><td><div class="c3">51</div></td><td></td><td></td><td></td><td></td><td><div>434</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $w = $weak_self-&gt;{_waiting};</td></tr>
<tr><td class="h">696</td><td><div class="c3">51</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L696">100</a></div></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--condition.html#L696">100</a></div></td><td></td><td></td><td><div>2337</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$w-&gt;[1]-&gt;send(1) if (ref $w &amp;&amp; defined $w-&gt;[1]);</td></tr>
<tr><td class="h">697</td><td><div class="c3">51</div></td><td></td><td></td><td></td><td></td><td><div>5765</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$weak_self-&gt;_write_now;</td></tr>
<tr><td class="h">698</td><td><div class="c3">51</div></td><td></td><td></td><td></td><td></td><td><div>1440</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1;</td></tr>
<tr><td class="h">699</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>638</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">700</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;return</td></tr>
<tr><td class="h">701</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>137</div></td><td class="s">}</td></tr>
<tr><td class="h">702</td><td colspan="7"></td></tr><tr><td class="h">703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_pingresp {</td></tr>
<tr><td class="h">704</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L704">3</a></div></td><td></td><td><div>45</div></td><td class="s">&nbsp;&nbsp;shift-&gt;_keep_alive_received();</td></tr>
<tr><td class="h">705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">706</td><td colspan="7"></td></tr><tr><td class="h">707</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_suback {</td></tr>
<tr><td class="h">708</td><td><div class="c3">13</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L708">13</a></div></td><td></td><td><div>101</div></td><td class="s">&nbsp;&nbsp;my ($self, $handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">709</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td></td><td><div>66</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;Confirmed subscription:\n&quot;, $msg-&gt;string(&#39;  &#39;), &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">710</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td></td><td><div>314</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_confirm_subscription($msg-&gt;message_id, $msg-&gt;qos_levels-&gt;[0]);</td></tr>
<tr><td class="h">711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;return</td></tr>
<tr><td class="h">712</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td></td><td><div>135</div></td><td class="s">}</td></tr>
<tr><td class="h">713</td><td colspan="7"></td></tr><tr><td class="h">714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_unsuback {</td></tr>
<tr><td class="h">715</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L715">3</a></div></td><td></td><td><div>28</div></td><td class="s">&nbsp;&nbsp;my ($self, $handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">716</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>18</div></td><td class="s">&nbsp;&nbsp;print STDERR &quot;Confirmed unsubscribe:\n&quot;, $msg-&gt;string(&#39;  &#39;), &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">717</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>122</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_confirm_unsubscribe($msg-&gt;message_id);</td></tr>
<tr><td class="h">718</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;return</td></tr>
<tr><td class="h">719</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>137</div></td><td class="s">}</td></tr>
<tr><td class="h">720</td><td colspan="7"></td></tr><tr><td class="h">721</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _publish_locally {</td></tr>
<tr><td class="h">722</td><td><div class="c3">16</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L722">16</a></div></td><td></td><td><div>134</div></td><td class="s">&nbsp;&nbsp;my ($self, $msg) = @_;</td></tr>
<tr><td class="h">723</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>479</div></td><td class="s">&nbsp;&nbsp;my $msg_topic = $msg-&gt;topic;</td></tr>
<tr><td class="h">724</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>919</div></td><td class="s">&nbsp;&nbsp;my $msg_data = $msg-&gt;message;</td></tr>
<tr><td class="h">725</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>950</div></td><td class="s">&nbsp;&nbsp;my $matches = $self-&gt;{_sub_topics}-&gt;values($msg_topic);</td></tr>
<tr><td class="h">726</td><td><div class="c3">16</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L726">100</a></div></td><td></td><td></td><td></td><td><div>1567</div></td><td class="s">&nbsp;&nbsp;unless (scalar @$matches) {</td></tr>
<tr><td class="h">727</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>48</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;carp &quot;Unexpected publish:\n&quot;, $msg-&gt;string(&#39;  &#39;), &quot;\n&quot;;</td></tr>
<tr><td class="h">728</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>1146</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">730</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>99</div></td><td class="s">&nbsp;&nbsp;my %matched;</td></tr>
<tr><td class="h">731</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>611</div></td><td class="s">&nbsp;&nbsp;my $msg_retain = $msg-&gt;retain;</td></tr>
<tr><td class="h">732</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>582</div></td><td class="s">&nbsp;&nbsp;foreach my $topic (@$matches) {</td></tr>
<tr><td class="h">733</td><td><div class="c3">19</div></td><td></td><td></td><td></td><td></td><td><div>444</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rec = $self-&gt;{_sub}-&gt;{$topic};</td></tr>
<tr><td class="h">734</td><td><div class="c3">19</div></td><td><div class="c0" title="-/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L734">50</a></div></td><td></td><td></td><td></td><td><div>207</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($msg_retain) {</td></tr>
<tr><td class="h">735</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="lib-AnyEvent-MQTT-pm--branch.html#L735">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($msg_data eq &#39;&#39;) {</td></tr>
<tr><td class="h">736</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $rec-&gt;{retained}-&gt;{$msg_topic};</td></tr>
<tr><td class="h">737</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;  retained cleared\n&quot; if DEBUG;</td></tr>
<tr><td class="h">738</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">739</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rec-&gt;{retained}-&gt;{$msg_topic} = $msg;</td></tr>
<tr><td class="h">740</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;  retained &#39;&quot;, $msg_data, &quot;&#39;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">741</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">743</td><td><div class="c3">19</div><div class="c3">19</div></td><td></td><td></td><td></td><td></td><td><div>118</div><div>258</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $cb (values %{$rec-&gt;{cb}}) {</td></tr>
<tr><td class="h">744</td><td><div class="c3">27</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L744">100</a></div></td><td></td><td></td><td></td><td><div>1109</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if ($matched{$cb}++);</td></tr>
<tr><td class="h">745</td><td><div class="c3">25</div></td><td></td><td></td><td></td><td></td><td><div>732</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cb-&gt;($msg_topic, $msg_data, $msg);</td></tr>
<tr><td class="h">746</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">747</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">748</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>1499</div></td><td class="s">&nbsp;&nbsp;1;</td></tr>
<tr><td class="h">749</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">750</td><td colspan="7"></td></tr><tr><td class="h">751</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_publish {</td></tr>
<tr><td class="h">752</td><td><div class="c3">16</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L752">16</a></div></td><td></td><td><div>184</div></td><td class="s">&nbsp;&nbsp;my ($self, $handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">753</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>500</div></td><td class="s">&nbsp;&nbsp;my $qos = $msg-&gt;qos;</td></tr>
<tr><td class="h">754</td><td><div class="c3">16</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L754">100</a></div></td><td></td><td></td><td></td><td><div>748</div></td><td class="s">&nbsp;&nbsp;if ($qos == MQTT_QOS_EXACTLY_ONCE) {</td></tr>
<tr><td class="h">755</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>44</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mid = $msg-&gt;message_id;</td></tr>
<tr><td class="h">756</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>56</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{messages}-&gt;{$mid} = $msg;</td></tr>
<tr><td class="h">757</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>16</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_send(message_type =&gt; MQTT_PUBREC, message_id =&gt; $mid);</td></tr>
<tr><td class="h">758</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>17</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">760</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>162</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_publish_locally($msg);</td></tr>
<tr><td class="h">761</td><td><div class="c3">15</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L761">100</a></div></td><td></td><td></td><td></td><td><div>213</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_send(message_type =&gt; MQTT_PUBACK, message_id =&gt; $msg-&gt;message_id)</td></tr>
<tr><td class="h">762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($qos == MQTT_QOS_AT_LEAST_ONCE);</td></tr>
<tr><td class="h">763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;return</td></tr>
<tr><td class="h">764</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>218</div></td><td class="s">}</td></tr>
<tr><td class="h">765</td><td colspan="7"></td></tr><tr><td class="h">766</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _inflight_record {</td></tr>
<tr><td class="h">767</td><td><div class="c3">7</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L767">7</a></div></td><td></td><td><div>44</div></td><td class="s">&nbsp;&nbsp;my ($self, $msg) = @_;</td></tr>
<tr><td class="h">768</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>208</div></td><td class="s">&nbsp;&nbsp;my $mid = $msg-&gt;message_id;</td></tr>
<tr><td class="h">769</td><td><div class="c3">7</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L769">100</a></div></td><td></td><td></td><td></td><td><div>217</div></td><td class="s">&nbsp;&nbsp;unless (exists $self-&gt;{inflight}-&gt;{$mid}) {</td></tr>
<tr><td class="h">770</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>70</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;carp &quot;Unexpected message for message id $mid\n  &quot;.$msg-&gt;string;</td></tr>
<tr><td class="h">771</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>2086</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">772</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">773</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>38</div></td><td class="s">&nbsp;&nbsp;my $exp_type = $self-&gt;{inflight}-&gt;{$mid}-&gt;{expect};</td></tr>
<tr><td class="h">774</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>108</div></td><td class="s">&nbsp;&nbsp;my $got_type = $msg-&gt;message_type;</td></tr>
<tr><td class="h">775</td><td><div class="c3">5</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L775">100</a></div></td><td></td><td></td><td></td><td><div>125</div></td><td class="s">&nbsp;&nbsp;unless ($got_type == $exp_type) {</td></tr>
<tr><td class="h">776</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>22</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;carp &#39;Received &#39;, message_type_string($got_type), &#39; but expected &#39;,</td></tr>
<tr><td class="h">777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_type_string($exp_type), &quot; for message id $mid\n&quot;;</td></tr>
<tr><td class="h">778</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>871</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">779</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">780</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>58</div></td><td class="s">&nbsp;&nbsp;return delete $self-&gt;{inflight}-&gt;{$mid};</td></tr>
<tr><td class="h">781</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">782</td><td colspan="7"></td></tr><tr><td class="h">783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_puback {</td></tr>
<tr><td class="h">784</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L784">3</a></div></td><td></td><td><div>22</div></td><td class="s">&nbsp;&nbsp;my ($self, $handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">785</td><td><div class="c3">3</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L785">100</a></div></td><td></td><td></td><td></td><td><div>25</div></td><td class="s">&nbsp;&nbsp;my $rec = $self-&gt;_inflight_record($msg) or return;</td></tr>
<tr><td class="h">786</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>40</div></td><td class="s">&nbsp;&nbsp;my $mid = $msg-&gt;message_id;</td></tr>
<tr><td class="h">787</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>45</div></td><td class="s">&nbsp;&nbsp;print STDERR &#39;PubAck: &#39;, $mid, &#39; &#39;, $rec-&gt;{cv}, &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">788</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>59</div></td><td class="s">&nbsp;&nbsp;$rec-&gt;{cv}-&gt;send(1);</td></tr>
<tr><td class="h">789</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>186</div></td><td class="s">&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">791</td><td colspan="7"></td></tr><tr><td class="h">792</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_pubrec {</td></tr>
<tr><td class="h">793</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L793">2</a></div></td><td></td><td><div>17</div></td><td class="s">&nbsp;&nbsp;my ($self, $handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">794</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L794">100</a></div></td><td></td><td></td><td></td><td><div>20</div></td><td class="s">&nbsp;&nbsp;my $rec = $self-&gt;_inflight_record($msg) or return;</td></tr>
<tr><td class="h">795</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>21</div></td><td class="s">&nbsp;&nbsp;my $mid = $msg-&gt;message_id;</td></tr>
<tr><td class="h">796</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>23</div></td><td class="s">&nbsp;&nbsp;print STDERR &#39;PubRec: &#39;, $mid, &#39; &#39;, $rec-&gt;{cv}, &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">797</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>14</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_send_with_ack({</td></tr>
<tr><td class="h">798</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_type =&gt; MQTT_PUBREL,</td></tr>
<tr><td class="h">799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qos =&gt; MQTT_QOS_AT_LEAST_ONCE,</td></tr>
<tr><td class="h">800</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message_id =&gt; $mid,</td></tr>
<tr><td class="h">801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, $rec-&gt;{cv}, MQTT_PUBCOMP);</td></tr>
<tr><td class="h">802</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">803</td><td colspan="7"></td></tr><tr><td class="h">804</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_pubrel {</td></tr>
<tr><td class="h">805</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L805">2</a></div></td><td></td><td><div>26</div></td><td class="s">&nbsp;&nbsp;my ($self, $handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">806</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>98</div></td><td class="s">&nbsp;&nbsp;my $mid = $msg-&gt;message_id;</td></tr>
<tr><td class="h">807</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>72</div></td><td class="s">&nbsp;&nbsp;print STDERR &#39;PubRel: &#39;, $mid, &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">808</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>32</div></td><td class="s">&nbsp;&nbsp;my $pubmsg = delete $self-&gt;{messages}-&gt;{$mid};</td></tr>
<tr><td class="h">809</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L809">100</a></div></td><td></td><td></td><td></td><td><div>31</div></td><td class="s">&nbsp;&nbsp;unless ($pubmsg) {</td></tr>
<tr><td class="h">810</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>36</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;carp &quot;Unexpected message for message id $mid\n  &quot;.$msg-&gt;string;</td></tr>
<tr><td class="h">811</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>987</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;}</td></tr>
<tr><td class="h">813</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>42</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_publish_locally($pubmsg);</td></tr>
<tr><td class="h">814</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>18</div></td><td class="s">&nbsp;&nbsp;$self-&gt;_send(message_type =&gt; MQTT_PUBCOMP, message_id =&gt; $mid);</td></tr>
<tr><td class="h">815</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">816</td><td colspan="7"></td></tr><tr><td class="h">817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _process_pubcomp {</td></tr>
<tr><td class="h">818</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L818">2</a></div></td><td></td><td><div>17</div></td><td class="s">&nbsp;&nbsp;my ($self, $handle, $msg, $error) = @_;</td></tr>
<tr><td class="h">819</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L819">100</a></div></td><td></td><td></td><td></td><td><div>19</div></td><td class="s">&nbsp;&nbsp;my $rec = $self-&gt;_inflight_record($msg) or return;</td></tr>
<tr><td class="h">820</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>23</div></td><td class="s">&nbsp;&nbsp;my $mid = $msg-&gt;message_id;</td></tr>
<tr><td class="h">821</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>23</div></td><td class="s">&nbsp;&nbsp;print STDERR &#39;PubComp: &#39;, $mid, &#39; &#39;, $rec-&gt;{cv}, &quot;\n&quot; if DEBUG;</td></tr>
<tr><td class="h">822</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>25</div></td><td class="s">&nbsp;&nbsp;$rec-&gt;{cv}-&gt;send(1);</td></tr>
<tr><td class="h">823</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>78</div></td><td class="s">&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">825</td><td colspan="7"></td></tr><tr><td class="h">826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=method C&lt;anyevent_read_type()&gt;</td></tr>
<tr><td class="h">827</td><td colspan="7"></td></tr><tr><td class="h">828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">This method is used to register an L&lt;AnyEvent::Handle&gt; read type</td></tr>
<tr><td class="h">829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">method to read MQTT messages.</td></tr>
<tr><td class="h">830</td><td colspan="7"></td></tr><tr><td class="h">831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">=cut</td></tr>
<tr><td class="h">832</td><td colspan="7"></td></tr><tr><td class="h">833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub anyevent_read_type {</td></tr>
<tr><td class="h">834</td><td><div class="c3">14</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L834">14</a></div></td><td></td><td><div>832</div></td><td class="s">&nbsp;&nbsp;my ($handle, $cb) = @_;</td></tr>
<tr><td class="h">835</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;subname &#39;anyevent_read_type_reader&#39; =&gt; sub {</td></tr>
<tr><td class="h">836</td><td><div class="c3">51</div></td><td></td><td></td><td><div class="c3"><a href="lib-AnyEvent-MQTT-pm--subroutine.html#L836">51</a></div></td><td></td><td><div>391434</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($handle) = @_;</td></tr>
<tr><td class="h">837</td><td><div class="c3">51</div></td><td></td><td></td><td></td><td></td><td><div>456</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rbuf = \$handle-&gt;{rbuf};</td></tr>
<tr><td class="h">838</td><td><div class="c3">51</div></td><td></td><td></td><td></td><td></td><td><div>689</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;weaken $rbuf;</td></tr>
<tr><td class="h">839</td><td><div class="c3">51</div></td><td><div class="c0" title="-/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L839">50</a></div></td><td></td><td></td><td></td><td><div>579</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless (defined $$rbuf);</td></tr>
<tr><td class="h">840</td><td><div class="c3">51</div></td><td></td><td></td><td></td><td></td><td><div>374</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (1) {</td></tr>
<tr><td class="h">841</td><td><div class="c3">109</div></td><td></td><td></td><td></td><td></td><td><div>3313</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg = Net::MQTT::Message-&gt;new_from_bytes($$rbuf, 1);</td></tr>
<tr><td class="h">842</td><td><div class="c3">109</div></td><td><div class="c3" title="T/F"><a href="lib-AnyEvent-MQTT-pm--branch.html#L842">100</a></div></td><td></td><td></td><td></td><td><div>28471</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last unless ($msg);</td></tr>
<tr><td class="h">843</td><td><div class="c3">58</div></td><td></td><td></td><td></td><td></td><td><div>520</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cb-&gt;($handle, $msg);</td></tr>
<tr><td class="h">844</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">845</td><td><div class="c3">51</div></td><td></td><td></td><td></td><td></td><td><div>1470</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">846</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>642</div></td><td class="s">&nbsp;&nbsp;};</td></tr>
<tr><td class="h">847</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">848</td><td colspan="7"></td></tr><tr><td class="h">849</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
